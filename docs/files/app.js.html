<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app.js - elastica-sample</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="elastica-sample"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/mychat.collection.Chat.html">mychat.collection.Chat</a></li>
            
                <li><a href="../classes/mychat.model.Chat.html">mychat.model.Chat</a></li>
            
                <li><a href="../classes/mychat.view.App.html">mychat.view.App</a></li>
            
                <li><a href="../classes/mychat.view.Chat.html">mychat.view.Chat</a></li>
            
                <li><a href="../classes/mychat.view.ChatContainer.html">mychat.view.ChatContainer</a></li>
            
                <li><a href="../classes/mychat.view.ChatInfo.html">mychat.view.ChatInfo</a></li>
            
                <li><a href="../classes/mychat.view.ChatList.html">mychat.view.ChatList</a></li>
            
                <li><a href="../classes/mychat.view.SearchChatForm.html">mychat.view.SearchChatForm</a></li>
            
                <li><a href="../classes/mychat.view.SendChatForm.html">mychat.view.SendChatForm</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/_.html">_</a></li>
            
                <li><a href="../modules/app.html">app</a></li>
            
                <li><a href="../modules/collection.html">collection</a></li>
            
                <li><a href="../modules/model.html">model</a></li>
            
                <li><a href="../modules/mychat.html">mychat</a></li>
            
                <li><a href="../modules/view.html">view</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function($, _) {

    /**
     * Extend Underscore module
     * @module _
     */
    _.extend(_, {

        /**
         * Compact object data.
         * Delete the object key if this value is false or empty value.
         * 
         * @namespace _
         * @method compactObject
         * @static
         * @param {Object} obj Target object to compact
         * @return {Object} Compacted object.
         */
        compactObject: function (obj) {
            var ret = {};
            _.each(obj, function (val, key) {
                if (val) {
                    ret[key] = val;
                }
            });
            return ret;
        },

        /**
         * Namespace utility.
         * 
         * @beta
         * @namespace _
         * @method namespace
         * @static
         * @param {String} string Namespace string.
         * @param {Object} [base] Base object of this namespace.
         */
        namespace: function(string, base) {
            base = base || window;
            var namespace;
            _.each(string.split(&#x27;.&#x27;), function(val) {
                if (! namespace) {
                    namespace = base;
                }

                namespace[val] = namespace[val] || {};
                namespace = namespace[val];
            });
        }
    });

    //TODO: RESTful API
    Backbone.orgSync = Backbone.sync;
    Backbone.sync = function(method, model, options) {
        if (method === &quot;delete&quot;) {
            this.url = &quot;./api/delete.php?id=&quot; + model.get(&#x27;id&#x27;);
        } else if (method === &quot;update&quot;) {
            this.url = &quot;./api/update.php?&quot; + $.param(_.compactObject(model.attributes));
        } else if (method === &quot;create&quot;) {
            this.url = &quot;./api/insert.php?&quot; + $.param(_.compactObject(model.attributes));
        } else {
            this.url = &quot;./api/search.php&quot;;
        }

        method = &quot;read&quot;;

        return Backbone.orgSync(method, model, options);
    };

    /**
     * This application module.
     * @module mychat
     */
    var mychat = __global__.mychat || {}

    /**
     * Model module
     * @module mychat
     * @submodule model
     */
    mychat.model = mychat.model || {};

    /**
     * Chat model
     * 
     * @class Chat
     * @extends Backbone.Model
     * @namespace mychat.model
     */
    mychat.model.Chat = Backbone.Model.extend({
        defaults: function() {
            return {
                /**
                 * User id
                 * @property userId
                 * @type {Int}
                 */
                userId: null,

                /**
                 * Room id
                 * 
                 * @property rid
                 * @type {Int}
                 */
                rid: null,

                /**
                 * Message
                 * 
                 * @required
                 * @property message
                 * @type {String}
                 */
                message: null
            };
        },

        /**
         * Validation method.
         * We check:
         * - {{#crossLink &quot;ChatMode:message&quot;}}message{{/crossLink}} is required.
         * 
         * @params {Object} attrs Attributes this model
         */
        validate: function(attrs) {
            if (! attrs.message) {
                return &#x27;Message is required.&#x27;;
            }
        }
    });

    /**
     * Submit event of saving chat
     * 
     * @method
     * @static
     * @namespace mychat.model.Chat
     * @param {String} message Chat message
     * @param {Object} [options]
     *   @param {Function} [options.success] callback function of success
     *   @param {Function} [options.error]   callback function of error
     */
    mychat.model.Chat.sendChat = function(message, options) {
        var chat = new ChatModel({
            message: message
            user_id: 1,  // dummy value
            room_id: 1   // dummy value
        });

        var jqxhr = chat.save();
        jqxhr &amp;&amp; _.isFunction(options.success) &amp;&amp; jqxhr.success(_.bind(options.success, chat));
        jqxhr &amp;&amp; _.isFunction(options.error)   &amp;&amp; jqxhr.error(_.bind(options.error, chat));
    };

    /**
     * Model module
     * 
     * @module mychat
     * @submodule collection
     */
    mychat.collection = mychat.collection || {};


    /**
     * Chat Collection
     * 
     * @class Chat
     * @extends Backbone.Collection
     * @namespace mychat.collection
     */
    mychat.collection.Chat = Backbone.Collection.extend({

        /**
         * API server URL
         * 
         * @property url
         * @type {String}
         */
        url: &quot;./api/search.php&quot;,

        /**
         * Fetching chat data time from api server. (seconds)
         * 
         * @property fetchTime
         * @type {Int}
         */
        fetchTime: 0,

        /**
         * Model data
         * 
         * @property model
         * @type {ChatModel}
         */
        model: mychat.model.Chat,

        /**
         * @method initialize
         * @constructor
         */
        initialize: function() {
            _.bindAll(this, &#x27;searchChat&#x27;, &#x27;fetchAllChat&#x27;);
        },

        /**
         * Parse response data
         * 
         * @protected
         * @method parse
         * @param {Object} response Response data from api server.
         */
        parse: function(response) {
            this.fetchTime = response.time;
            return response.data;
        },

        /**
         * Search chat data.
         * 
         * @async
         * @method searchChat
         * @namespace mychat.collection
         * @param {Object} params  Response data from api server.
         *   @param {Int} [params.user_id]  User id.
         *   @param {Int} [params.rid]      Room id.
         *   @param {String} params.message  Message.
         * @param {Object} [options] Response data from api server.
         *   @param {Function} [options.success]  Callback function of success.
         *   @param {Function} [options.error]    Callback function of error.
         */
        searchChat: function(params, options) {
            _.isObject(params) || (params = {});
            params = _.pick(params || {}, [
                &#x27;user_id&#x27;,
                &#x27;rid&#x27;,
                &#x27;message&#x27;
            ]);

            options = _.defaults({}, options);

            this.fetch({
                data: $.param(params),
                success: _.bind(function(collection) {
                    this.reset(collection.models);
                    _.isFunction(options.success) &amp;&amp; options.success.apply(this, arguments);
                }, this),
                error: _.bind(function(err) {
                    _.isFunction(options.error) &amp;&amp; options.error.apply(this, arguments);
                }, this)
            });
        },

        /**
         * Fetch all chat data from server.
         * 
         * @async
         * @method fetchAllChat
         * @param {Object} params  Response data from api server.
         *   @param {Int} [params.user_id]  User id.
         *   @param {Int} [params.rid]      Room id.
         *   @param {String} params.message  Message.
         * @param {Object} [options] Response data from api server.
         *   @param {Function} [options.success]  Callback function of success.
         *   @param {Function} [options.error]    Callback function of error.
         */
        fetchAllChat: function(options) {
            return this.searchChat(null, options);
        }
    });


    /**
     * View module
     * 
     * @module mychat
     * @submodule view
     */
    mychat.view = mychat.view || {};


    /**
     * Application view
     * 
     * @class App
     * @extends Backbone.View
     * @namespace mychat.view
     */
    mychat.view.App = Backbone.View.extend({

        /**
         * Element
         * 
         * @type {String} element
         */
        el: &#x27;#container&#x27;,

        /**
         * @module app
         * @submodule view
         * @type {String} element
         */
        view: {},

        /**
         * @constructor
         * @class mychat.view.App
         */
        initialize: function() {

            // Render init view
            var chat_collection = new ChatCollection({});
            chat_collection.fetchAllChat({
                success: _.bind(function(collection) {
                    this.view.chatContainerView = new ChatContainerView({collection: chat_collection});
                }, this),
                error: function(err) {
                    console.log(err);
                }
            });

            this.view.searchChatFormView = new SearchChatFormView({collection: chat_collection});
            this.view.sendChatFormView = new SendChatFormView({collection: chat_collection});
        }
    });

    /**
     * Form view for searching chat.
     * 
     * @namespace mychat.view
     * @class SearchChatForm
     * @extends Backbone.View
     */
    mychat.view.SearchChatForm = Backbone.View.extend({

        /**
         * Element
         * 
         * @type {String} element
         */
        el: &#x27;#search-form&#x27;,

        /**
         * @type ChatCollection
         */
        collection: null,

        /**
         * Events map
         * @type {Object}
         */
        events: {
            &#x27;click #search-btn&#x27;: &#x27;submit&#x27;
        },

        /**
         * Submit event of searching chat
         * 
         * @type {String} element
         */
        submit: function() {
            if (! this.collection) {
                return;
            }

            var attrs = {};
            this.$(&#x27;.param&#x27;).each(function() {
                var $this = $(this);
                attrs[$this.attr(&#x27;name&#x27;)] = $this.val();
            });
            this.collection.searchChat(attrs);
        }
    });

    /**
     * Form view for sending chat.
     * 
     * @namespace mychat.view
     * @class SendChatForm
     * @extends Backbone.View
     */
    mychat.view.SendChatForm = Backbone.View.extend({
        /**
         * Element
         * 
         * @type {String} element
         */
        el: &#x27;#insert-form&#x27;,

        /**
         * @type ChatCollection
         */
        collection: null,

        /**
         * Events map
         * @type {Object}
         */
        events: {
            &#x27;click #insert-btn&#x27;: &#x27;sendChat&#x27;
        },


        addChat: function(model) {
            this.collection.add(model);
            app.view.chatContainerView.chatListView.addChatView(model);
        }
    });

    /**
     * Chat container view
     * 
     * @namespace mychat.view
     * @class ChatContainer
     * @extends Backbone.View
     */
    mychat.view.ChatContainer = Backbone.View.extend({
        collection: null,
        initialize: function() {
            this.chatInfoView = new ChatInfoView({collection: this.collection});
            this.chatListView = new ChatListView({collection: this.collection});
        }
    });

    /**
     * Form view for sending chat.
     * 
     * @namespace mychat.view
     * @class ChatInfo
     * @extends Backbone.View
     */
    mychat.view.ChatInfo = Backbone.View.extend({
        el: &#x27;#chat-info&#x27;,
        collection: null,
        initialize: function() {
            this.listenTo(this.collection, &#x27;reset&#x27;,   this.render);
            this.listenTo(this.collection, &#x27;destroy&#x27;, this.render);
            this.render();
        },
        render: function() {
            if (! this.collection) {
                return;
            }

            this.$(&#x27;#chat-count&#x27;).text(this.collection.length);
            this.$(&#x27;#chat-response-time&#x27;).text(this.collection.fetchTime);
            return this;
        }
    });

    /**
     * Chat list view
     * 
     * @namespace mychat.view
     * @class ChatList
     * @extends Backbone.View
     */
    mychat.view.ChatList = Backbone.View.extend({
        el: &#x27;#chat-list&#x27;,

        /**
         * @type ChatCollection
         */
        collection: null,

        initialize: function() {
            // Listen some events
            this.listenTo(this.collection, &#x27;reset&#x27;,  this.render);
            this.render();
        },

        render: function() {
            if (! this.collection) {
                return this;
            }

            this.$(&#x27;ul&#x27;).empty();
            this.collection.each(_.bind(function(model) {
                var view = new ChatView({model: model})
                this.$(&#x27;ul&#x27;).append(view.$el);
            }, this));
            return this;
        },

        addChatView: function(model) {
            var view = new ChatView({model: model});
            view.$el.hide();
            this.$(&#x27;ul&#x27;).prepend(view.$el);
            view.$el.fadeIn();
        }
    });

    /**
     * Chat view
     * 
     * @namespace mychat.view
     * @class Chat
     * @extends Backbone.View
     */
    mychat.view.Chat = Backbone.View.extend({
        /**
         * @type ChatModel
         */
        model: null,

        isEditing: false,

        events: {
            &#x27;dblclick  .message&#x27;:  &#x27;changeToEditableView&#x27;,
            &#x27;click .delete-chat&#x27;:  &#x27;removeChat&#x27;,
            &#x27;blur .edit-message&#x27;:  &#x27;updateChat&#x27;,
            &#x27;keypress .edit-message&#x27;:  &#x27;enterOnEditMessage&#x27;
        },

        initialize: function() {
            _.bindAll(this, &#x27;finishEditableView&#x27;);
            this.listenTo(this.model, &#x27;destroy&#x27;, this.fadeOutView);
            this.render();
        },

        template: $(&#x27;#chat-list-template&#x27;).html(),

        render: function() {
            if (! this.model) {
                return this;
            }

            var html = _.template(this.template, this.model.attributes);
            this.$el.html(html);
            return this;
        },

        removeChat: function() {
            this.model.destroy();
        },

        updateChat: function() {
            var new_message = this.$(&#x27;.edit-message&#x27;).val();
            this.model.save({
                message: new_message
            }).always(this.finishEditableView);
        },

        enterOnEditMessage: function(e) {
            if (e.keyCode != 13) return;     // keyCode === 13 : EnterKey
            this.updateChat();
        },

        changeToEditableView: function() {
            this.$(&#x27;.message&#x27;).hide();
            this.$(&#x27;.delete-chat&#x27;).hide();
            this.$(&#x27;.edit-message&#x27;).show().focus().val(this.model.get(&#x27;message&#x27;));
            this.isEditing = true;
        },

        finishEditableView: function() {
            this.$(&#x27;.message&#x27;).show();
            this.$(&#x27;.delete-chat&#x27;).show();
            this.$(&#x27;.edit-message&#x27;).hide();
            this.updateView();
            this.isEditing = false;
        },

        fadeOutView: function() {
            this.$el.fadeOut();
        },

        updateView: function(model) {
            this.$(&#x27;.message&#x27;).text(this.model.get(&#x27;message&#x27;));
        }
    });

    var app;
    $(function() {
        app = new AppView();
    });

})(jQuery, _);

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
